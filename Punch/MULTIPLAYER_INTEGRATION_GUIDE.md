# Руководство по интеграции мультиплеера в "Кролик Панч"

## Обзор системы

Мультиплеерная система реализована с использованием GameScore SDK и состоит из двух основных компонентов:
- `multiplayer.js` - основная логика мультиплеера
- `multiplayer-integration.js` - интеграция с Construct 3

## Архитектура

### Принцип работы
1. **Матчмейкинг** - поиск игроков через глобальное хранилище GameScore
2. **Синхронизация** - обмен данными между игроками через облачное хранилище
3. **Реалтайм обновления** - периодическая проверка состояния игры

### Компоненты системы
- `MultiplayerManager` - основной класс управления мультиплеером
- `MultiplayerIntegration` - интеграция с Construct 3
- Глобальные функции для взаимодействия с игрой

## Интеграция в Construct 3

### 1. Добавление кнопки "Играть с случайным игроком"

В меню игры добавьте новую кнопку:

**Event Sheet: menuEvent**
```
// Добавить событие для кнопки мультиплеера
On touched object: multiplayerButton
-> Browser: Execute JavaScript: "StartMultiplayerMatchmaking()"
```

### 2. Создание UI элементов

Создайте следующие объекты в Construct 3:

**Объекты для мультиплеера:**
- `multiplayerButton` - кнопка "Играть с случайным игроком"
- `matchmakingUI` - интерфейс поиска игры
- `opponentName` - имя противника
- `opponentScore` - счет противника
- `multiplayerResult` - результат мультиплеерной игры

### 3. Обработка событий мультиплеера

**Функции для создания в Construct 3:**

```javascript
// Функция запуска мультиплеерной игры
function OnMultiplayerGameStart(opponentId, gameId) {
    // Скрыть меню
    // Показать игровой экран
    // Установить режим мультиплеера
    // Показать информацию о противнике
}

// Функция обработки хода противника
function OnOpponentMove(moveType, x, y, score, combo) {
    // Обработать ход противника
    // Обновить визуальную часть
    // Показать эффекты
}

// Функция показа UI поиска
function OnShowMatchmakingUI() {
    // Показать экран поиска игры
    // Скрыть меню
}

// Функция скрытия UI поиска
function OnHideMatchmakingUI() {
    // Скрыть экран поиска игры
    // Показать меню
}

// Функция показа мультиплеерного UI
function OnShowMultiplayerUI(opponentId) {
    // Показать UI мультиплеера
    // Отобразить имя противника
    // Показать счетчики очков
}

// Функция завершения игры
function OnMultiplayerGameEnd(result, myScore, opponentScore) {
    // Показать результат игры
    // result: "win", "lose", "draw"
    // Обновить статистику
    // Показать кнопку возврата в меню
}
```

### 4. Отправка ходов в мультиплеере

В основной игровой логике добавьте отправку ходов:

**Event Sheet: gameEvent**
```javascript
// При успешном ударе
On collision: theRabbit with redbox/bluebox
-> Browser: Execute JavaScript: 
   "SendMultiplayerMove('punch', theRabbit.X, theRabbit.Y, score, combo)"

// При промахе
On collision: theRabbit with wrong target
-> Browser: Execute JavaScript: 
   "SendMultiplayerMove('miss', theRabbit.X, theRabbit.Y, score, combo)"
```

### 5. Проверка состояния мультиплеера

Добавьте проверки в игровую логику:

```javascript
// Проверка активности мультиплеера
function IsMultiplayerActive() {
    return window.IsMultiplayerActive();
}

// Получение состояния мультиплеера
function GetMultiplayerInfo() {
    return window.GetMultiplayerState();
}
```

## Настройка GameScore

### Необходимые настройки в панели GameScore:

1. **Глобальное хранилище** - включить для синхронизации игр
2. **Таблицы лидеров** - создать таблицу "multiplayer"
3. **Облачное хранилище** - настроить для сохранения состояния игр

### Структура данных в хранилище:

```javascript
// Список игр: multiplayer_games_list
[
    {
        "id": "game_1234567890_12345",
        "host": 12345,
        "hostName": "Игрок1",
        "status": "waiting",
        "playersCount": 1,
        "createdAt": 1234567890
    }
]

// Данные игры: multiplayer_game_[gameId]
{
    "id": "game_1234567890_12345",
    "host": 12345,
    "status": "playing",
    "playersCount": 2,
    "createdAt": 1234567890,
    "players": {
        "12345": {
            "id": 12345,
            "name": "Игрок1",
            "score": 150,
            "ready": true
        },
        "67890": {
            "id": 67890,
            "name": "Игрок2",
            "score": 120,
            "ready": true
        }
    },
    "moves": [
        {
            "playerId": 12345,
            "timestamp": 1234567890,
            "data": {
                "type": "punch",
                "x": 100,
                "y": 200,
                "score": 150,
                "combo": 3
            }
        }
    ]
}
```

## Пример использования

### Полный цикл мультиплеерной игры:

1. **Игрок нажимает кнопку "Играть с случайным игроком"**
2. **Система ищет доступные игры или создает новую**
3. **При найденном противнике начинается игра**
4. **Игроки играют, их ходы синхронизируются**
5. **По окончании времени показывается результат**
6. **Игроки возвращаются в меню**

### Код для кнопки мультиплеера:

```javascript
// В Event Sheet
On touched object: multiplayerButton
-> Browser: Execute JavaScript: "
    if (window.MultiplayerIntegration && window.MultiplayerIntegration.isReady()) {
        StartMultiplayerMatchmaking();
    } else {
        // Показать сообщение об ошибке
        alert('Мультиплеер недоступен');
    }
"
```

## Отладка и тестирование

### Консольные команды для отладки:

```javascript
// Проверка состояния мультиплеера
console.log(window.GetMultiplayerState());

// Принудительное завершение игры
window.EndMultiplayerGame();

// Отмена поиска игры
window.CancelMultiplayerMatchmaking();
```

### Тестирование:

1. Откройте игру в двух вкладках браузера
2. В первой вкладке нажмите "Играть с случайным игроком"
3. Во второй вкладке также нажмите кнопку мультиплеера
4. Игроки должны соединиться и начать игру

## Возможные проблемы и решения

### Проблема: Игроки не соединяются
**Решение:** Проверьте настройки GameScore и доступность глобального хранилища

### Проблема: Ходы не синхронизируются
**Решение:** Убедитесь, что функция `SendMultiplayerMove` вызывается правильно

### Проблема: Игра не завершается
**Решение:** Проверьте логику подсчета времени и вызов `EndMultiplayerGame`

## Дополнительные возможности

### Расширение функциональности:

1. **Чат между игроками** - через дополнительные поля в хранилище
2. **Приглашение друзей** - интеграция с социальными функциями ВК
3. **Рейтинговая система** - использование таблиц лидеров
4. **Турниры** - создание турнирных сеток

### Оптимизация:

1. **Кэширование данных** - сохранение состояния локально
2. **Сжатие данных** - минимизация трафика
3. **Обработка ошибок** - восстановление соединения

## Заключение

Мультиплеерная система готова к использованию и может быть легко интегрирована в существующую игру. Система обеспечивает:

- ✅ Автоматический поиск игроков
- ✅ Синхронизацию ходов в реальном времени
- ✅ Подсчет результатов и рейтинг
- ✅ Интеграцию с социальными функциями ВК
- ✅ Обработку ошибок и отключений

Для полной интеграции необходимо добавить соответствующие UI элементы и события в Construct 3 согласно данному руководству. 