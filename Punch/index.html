<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .players {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .player {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
        
        .success {
            color: green;
            font-weight: bold;
        }
        
        .info {
            color: blue;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üê∞ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞</h1>
        <p>–°—Ç–∞—Ç—É—Å: <span id="status">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="user">–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</span></p>
        
        <div>
            <button onclick="initVK()">1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å VK</button>
            <button onclick="testStorage()">2. –¢–µ—Å—Ç Storage</button>
            <button onclick="joinRoom()">3. –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
            <button onclick="showPlayers()">4. –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤</button>
            <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
    </div>

    <div class="container">
        <h2>üë• –ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</h2>
        <div id="players" class="players">
            –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤
        </div>
    </div>

    <div class="container">
        <h2>üìã –õ–æ–≥</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        let vkBridge = null;
        let user = null;
        let roomId = 'test-room';
        
        // –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.innerHTML = `[${time}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK
        async function initVK() {
            try {
                log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é VK Bridge...', 'info');
                updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
                
                if (typeof window.vkBridge === 'undefined') {
                    log('‚ùå VK Bridge –Ω–µ –Ω–∞–π–¥–µ–Ω!', 'error');
                    updateStatus('VK Bridge –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                vkBridge = window.vkBridge;
                log('‚úÖ VK Bridge –Ω–∞–π–¥–µ–Ω', 'success');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                await vkBridge.send('VKWebAppInit');
                log('‚úÖ VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
                user = {
                    id: userInfo.id,
                    name: `${userInfo.first_name} ${userInfo.last_name}`
                };
                
                log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.name} (ID: ${user.id})`, 'success');
                document.getElementById('user').textContent = user.name;
                updateStatus('–ì–æ—Ç–æ–≤');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞');
            }
        }
        
        // –¢–µ—Å—Ç Storage
        async function testStorage() {
            if (!vkBridge) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ VK!', 'error');
                return;
            }
            
            try {
                log('–¢–µ—Å—Ç–∏—Ä—É–µ–º VK Storage...', 'info');
                
                // –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏
                const testData = {
                    test: 'hello',
                    timestamp: Date.now(),
                    user: user?.name || 'unknown'
                };
                
                await vkBridge.send('VKWebAppStorageSet', {
                    key: 'test_key',
                    value: JSON.stringify(testData)
                });
                log('‚úÖ –ó–∞–ø–∏—Å—å –≤ Storage: OK', 'success');
                
                // –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è
                const result = await vkBridge.send('VKWebAppStorageGet', {
                    keys: ['test_key']
                });
                
                log(`‚úÖ –ß—Ç–µ–Ω–∏–µ –∏–∑ Storage: ${JSON.stringify(result)}`, 'success');
                
                if (result.keys && result.keys[0] && result.keys[0].value) {
                    const data = JSON.parse(result.keys[0].value);
                    log(`‚úÖ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã: ${data.test}`, 'success');
                } else {
                    log('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!', 'error');
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ Storage: ${error.message}`, 'error');
            }
        }
        
        // –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É
        async function joinRoom() {
            if (!vkBridge || !user) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ VK!', 'error');
                return;
            }
            
            try {
                log(`–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ${roomId}`, 'info');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
                const result = await vkBridge.send('VKWebAppStorageGet', {
                    keys: [`room_${roomId}`]
                });
                
                let roomData = { players: {} };
                if (result.keys && result.keys[0] && result.keys[0].value) {
                    roomData = JSON.parse(result.keys[0].value);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è
                roomData.players[user.id] = {
                    id: user.id,
                    name: user.name,
                    joinTime: Date.now(),
                    status: 'online'
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º
                await vkBridge.send('VKWebAppStorageSet', {
                    key: `room_${roomId}`,
                    value: JSON.stringify(roomData)
                });
                
                log(`‚úÖ –í–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É! –ò–≥—Ä–æ–∫–æ–≤: ${Object.keys(roomData.players).length}`, 'success');
                showPlayers();
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É: ${error.message}`, 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–∫–æ–≤
        async function showPlayers() {
            if (!vkBridge) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ VK!', 'error');
                return;
            }
            
            try {
                log('–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤...', 'info');
                
                const result = await vkBridge.send('VKWebAppStorageGet', {
                    keys: [`room_${roomId}`]
                });
                
                const playersDiv = document.getElementById('players');
                
                if (!result.keys || !result.keys[0] || !result.keys[0].value) {
                    playersDiv.innerHTML = '–ö–æ–º–Ω–∞—Ç–∞ –ø—É—Å—Ç–∞';
                    log('–ö–æ–º–Ω–∞—Ç–∞ –ø—É—Å—Ç–∞', 'info');
                    return;
                }
                
                const roomData = JSON.parse(result.keys[0].value);
                const players = Object.values(roomData.players);
                
                log(`–ù–∞–π–¥–µ–Ω–æ –∏–≥—Ä–æ–∫–æ–≤: ${players.length}`, 'info');
                
                playersDiv.innerHTML = players.map(player => `
                    <div class="player">
                        <strong>${player.name}</strong> (ID: ${player.id})
                        <br>–°—Ç–∞—Ç—É—Å: ${player.status}
                        <br>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞: ${new Date(player.joinTime).toLocaleTimeString()}
                    </div>
                `).join('');
                
                players.forEach(player => {
                    log(`üë§ ${player.name} - ${player.status}`, 'info');
                });
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤: ${error.message}`, 'error');
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
        setInterval(showPlayers, 5000);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å VK"', 'info');
        });
    </script>
</body>
</html> 
