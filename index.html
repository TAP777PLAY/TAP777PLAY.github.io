// Обновленные паттерны для блокированных ячеек
const patterns = [
    // Группа из 3-5 блоков вместе
    (board) => {
        const blockCount = Math.floor(Math.random() * 3) + 3; // 3-5 блоков
        const startX = Math.floor(Math.random() * 7);
        const startY = Math.floor(Math.random() * 7);
        
        for(let i = 0; i < blockCount; i++) {
            const offsetX = Math.floor(Math.random() * 3);
            const offsetY = Math.floor(Math.random() * 3);
            if(startX + offsetX < 10 && startY + offsetY < 10) {
                board[startY + offsetY][startX + offsetX] = 1;
            }
        }
        return board;
    },
    // Разделенные блоки (3-4 блока далеко друг от друга)
    (board) => {
        const blockCount = Math.floor(Math.random() * 2) + 3; // 3-4 блока
        const usedPositions = new Set();
        
        for(let i = 0; i < blockCount; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * 10);
                y = Math.floor(Math.random() * 10);
            } while(usedPositions.has(`${x},${y}`) || hasNearbyBlocks(board, x, y));
            
            board[y][x] = 1;
            usedPositions.add(`${x},${y}`);
        }
        return board;
    }
];

// Проверка наличия близких блоков
function hasNearbyBlocks(board, x, y) {
    for(let i = -2; i <= 2; i++) {
        for(let j = -2; j <= 2; j++) {
            if(x + i >= 0 && x + i < 10 && y + j >= 0 && y + j < 10) {
                if(board[y + j][x + i] === 1) return true;
            }
        }
    }
    return false;
}

// Настройки сложности для разных уровней
const difficultyPresets = {
    1: { moves: 25, targets: 20, crystals: 25 },  // Очень легкий
    2: { moves: 30, targets: 25, crystals: 30 },  // Легкий
    3: { moves: 35, targets: 30, crystals: 35 },  // Средний
    4: { moves: 40, targets: 35, crystals: 40 },  // Сложный
    5: { moves: 45, targets: 40, crystals: 45 },  // Очень сложный
    6: { moves: 50, targets: 45, crystals: 50 },  // Эксперт
    7: { moves: 60, targets: 50, crystals: 55 },  // Мастер
    8: { moves: 65, targets: 55, crystals: 60 },  // Гранд-мастер
    9: { moves: 70, targets: 60, crystals: 65 },  // Легенда
    10: { moves: 75, targets: 65, crystals: 70 }  // Невозможный
};

function generateLevelData(difficulty, index) {
    const levelData = {
        "c2array": true,
        "size": [4, 1, 1],
        "data": [
            [["redfoc-sweetsaga"]],
            [[]],
            [[]],
            [[0]]
        ]
    };

    const settings = difficultyPresets[difficulty];
    const boardSize = 10;
    let board = Array(boardSize).fill().map(() => Array(boardSize).fill(0));
    
    // Применяем случайный паттерн блокировки
    const patternIndex = Math.floor(Math.random() * patterns.length);
    board = patterns[patternIndex](board);

    // Размещаем целевые элементы, избегая блокированных ячеек
    let placedTargets = 0;
    const targetCount = Math.min(settings.targets, 20); // Ограничиваем количество целевых элементов
    
    while(placedTargets < targetCount) {
        const x = Math.floor(Math.random() * boardSize);
        const y = Math.floor(Math.random() * boardSize);
        if(board[y][x] === 0) {
            board[y][x] = 2;
            placedTargets++;
        }
    }

    const layoutData = {
        c2array: true,
        size: [10, 10, 1],
        data: board.map(row => row.map(cell => [cell]))
    };

    const settingsData = {
        c2array: true,
        size: [10, 4, 1],
        data: [
            [[0], ["1"], ["4"], ["6"]],
            [[settings.moves], [settings.moves], [settings.moves], [0]],
            [[settings.crystals], [settings.crystals], [settings.crystals], [0]],
            [["6"], [0], [0], [0]],
            [[0], [0], [0], [0]],
            [[0], [0], [0], [0]],
            [[0], [0], [0], [0]],
            [[0], [0], [0], [0]],
            [[0], [0], [0], [0]],
            [[0], [0], [0], [0]]
        ]
    };

    levelData.data[1][0] = [JSON.stringify(layoutData)];
    levelData.data[2][0] = [JSON.stringify(settingsData)];

    return JSON.stringify(levelData, null, 4);
}
